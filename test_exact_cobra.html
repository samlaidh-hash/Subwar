<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exact Oolite Cobra Conversion Test</title>
    <style>
        body {
            margin: 0;
            background: linear-gradient(to bottom, #001122, #003366);
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #00ff88;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.4;
            z-index: 100;
            max-width: 300px;
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #00ff88;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .status {
            color: #ffff00;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>ðŸš¢ EXACT OOLITE COBRA CONVERSION</h3>
        <p><strong>Purpose:</strong> Load actual Cobra3.json data using precise converter</p>
        <ul>
            <li>âœ… Reads original Oolite vertex data</li>
            <li>âœ… Converts face indices exactly</li>
            <li>âœ… Maintains original proportions</li>
            <li>âœ… Preserves Oolite coordinate system</li>
        </ul>
        <p><strong>Status:</strong> <span id="status" class="status">Loading converter...</span></p>
        <p><strong>Model Info:</strong> <span id="modelInfo">-</span></p>
    </div>

    <div id="controls">
        <p><strong>Controls:</strong> Mouse to rotate â€¢ Scroll to zoom</p>
        <p><strong>V:</strong> Toggle wireframe â€¢ <strong>R:</strong> Reset view</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="oolite_threejs_converter.js"></script>

    <script>
        let scene, camera, renderer, cobra, converter;
        let rotationSpeed = 0.01;
        let wireframeMode = false;

        async function init() {
            try {
                console.log('ðŸš¢ Initializing Exact Oolite Cobra Test...');
                document.getElementById('status').textContent = 'Initializing Three.js...';

                // Create scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x001133);

                // Create camera
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(15, 8, 15);
                camera.lookAt(0, 0, 0);

                // Create renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(renderer.domElement);

                // Add lights
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(20, 20, 10);
                directionalLight.castShadow = true;
                scene.add(directionalLight);

                const pointLight = new THREE.PointLight(0x00ff88, 0.4, 50);
                pointLight.position.set(0, 10, 0);
                scene.add(pointLight);

                console.log('âœ… Three.js initialized');
                document.getElementById('status').textContent = 'Loading Oolite converter...';

                // Initialize converter
                converter = new OoliteThreeJSConverter();
                console.log('âœ… Converter initialized');

                document.getElementById('status').textContent = 'Loading Cobra3.json...';

                // Debug: Load and examine the JSON data first
                console.log('ðŸ“Š Loading cobra3.json for inspection...');
                const response = await fetch('models/cobra3.json');
                const jsonData = await response.json();

                console.log('ðŸ” JSON Data Structure:');
                console.log('Vertices array length:', jsonData.vertices?.length);
                console.log('Indices array length:', jsonData.indices?.length);
                console.log('First 10 vertices:', jsonData.vertices?.slice(0, 10));
                console.log('First 20 indices:', jsonData.indices?.slice(0, 20));
                console.log('Metadata:', jsonData.metadata);

                // Check if indices make sense
                const maxVertexIndex = (jsonData.vertices?.length || 0) / 3 - 1;
                const invalidIndices = jsonData.indices?.filter(idx => idx > maxVertexIndex) || [];
                console.log('Max valid vertex index:', maxVertexIndex);
                console.log('Invalid indices found:', invalidIndices.length);

                // Load the exact Cobra model
                const cobraGeometry = await converter.loadModel('models/cobra3.json', 'Cobra3');

                // Update model info
                const bounds = cobraGeometry.userData.bounds;
                document.getElementById('modelInfo').innerHTML = `
                    Vertices: ${cobraGeometry.userData.originalVertexCount}<br>
                    Faces: ${cobraGeometry.userData.originalFaceCount}<br>
                    Size: ${bounds.maxDimension.toFixed(1)} units<br>
                    Bounds: ${bounds.maxX.toFixed(1)} Ã— ${bounds.maxY.toFixed(1)} Ã— ${bounds.maxZ.toFixed(1)}
                `;

                // Create material
                const material = new THREE.MeshLambertMaterial({
                    color: 0x888888,
                    side: THREE.DoubleSide
                });

                // Create the exact Cobra mesh
                cobra = converter.createMesh('Cobra3', material, {
                    scale: 1.0,  // Use original scale to see exact proportions
                    position: { x: 0, y: 0, z: 0 },
                    rotation: { x: 0, y: 0, z: 0 }
                });

                scene.add(cobra);

                document.getElementById('status').textContent = 'Exact Cobra loaded successfully! âœ…';
                console.log('âœ… Exact Oolite Cobra model loaded and displayed');

                // Setup controls
                setupControls();

                // Start animation
                animate();

            } catch (error) {
                console.error('âŒ Failed to load Cobra:', error);
                document.getElementById('status').textContent = `Error: ${error.message}`;

                // Fallback: create a simple placeholder
                const fallbackGeometry = new THREE.BoxGeometry(2, 1, 4);
                const fallbackMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
                cobra = new THREE.Mesh(fallbackGeometry, fallbackMaterial);
                scene.add(cobra);

                setupControls();
                animate();
            }
        }

        function setupControls() {
            let isMouseDown = false;
            let mouseX = 0, mouseY = 0;

            // Mouse controls
            document.addEventListener('mousedown', (event) => {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            document.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            document.addEventListener('mousemove', (event) => {
                if (!isMouseDown || !cobra) return;

                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;

                cobra.rotation.y += deltaX * 0.01;
                cobra.rotation.x += deltaY * 0.01;

                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            // Zoom
            document.addEventListener('wheel', (event) => {
                const zoomFactor = 1 + event.deltaY * 0.001;
                camera.position.multiplyScalar(zoomFactor);
                camera.position.clampLength(5, 100);
            });

            // Keyboard controls
            document.addEventListener('keydown', (event) => {
                switch (event.key.toLowerCase()) {
                    case 'v':
                        toggleWireframe();
                        break;
                    case 'r':
                        resetView();
                        break;
                }
            });
        }

        function toggleWireframe() {
            if (!cobra) return;

            wireframeMode = !wireframeMode;
            cobra.material.wireframe = wireframeMode;

            console.log(`Wireframe mode: ${wireframeMode ? 'ON' : 'OFF'}`);
        }

        function resetView() {
            camera.position.set(15, 8, 15);
            camera.lookAt(0, 0, 0);

            if (cobra) {
                cobra.rotation.set(0, 0, 0);
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            // Auto-rotate slowly
            if (cobra) {
                cobra.rotation.y += rotationSpeed;
            }

            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start the application
        window.addEventListener('load', init);
    </script>
</body>
</html>